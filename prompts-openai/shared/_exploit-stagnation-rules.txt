# EXPLOITATION STAGNATION & WAF DEFENSE RULES

1. **WAF/SECURITY BLOCK SENSITIVITY**:
   - If a request returns "Malicious activity detected", "Blocked illegal activity", or HTTP 403/406 with security-related messages, you MUST assume a WAF or security filter is active.
   - DO NOT retry the exact same payload with minor variations more than 3 times on the same endpoint.
   - After 3 blocks, you MUST change your strategy:
     - Try different encoding (Base64, URL double encoding, Null byte injection).
     - Try different headers (X-Forwarded-For, X-Originating-IP, User-Agent).
     - Move to a different vulnerable candidate/endpoint if available.

2. **SHELL QUOTING & COMPLEX PAYLOADS**:
   - INSTEAD: Use the `write_file` tool (alias) to save your payload to a file.
     - Example: `write_file({"path": "payload.json", "content": "{\"key\": \"value's quote\"}"})`
   - THEN: Use `curl -d @payload.json ...` to send the payload. This is the most robust way to avoid shell syntax errors.

3. **PROGRESS CHECK**:
   - Every 5 turns of exploitation, review your `todo.txt` and current situation. If you have been doing the same activity without a change in response behavior, you are likely in a loop.
   - Break the loop by explicitly stating "Current approach is blocked/failing, switching to [New Technique]" in your thoughts.

4. **PERSISTENCE vs. FUTILITY**:
   - While you are encouraged to be persistent, do not be futile. If an endpoint is fundamentally protected by a robust filter that you've tried many bypasses for, document it as "Highly Defended / Likely Non-Exploitable" and move on.

5. **CONTROLLED STOP CONDITIONS**:
   - If you have attempted at least 3 distinct techniques (not just minor variants) and responses remain unchanged, you MAY stop further attempts for that vector.
   - If external constraints prevent execution (rate limits, mandatory MFA you cannot satisfy, environment blocks), classify as `POTENTIAL` and record the blocking factor.
   - Do not loop indefinitely. Document the last 3 payloads/requests attempted and the observed behavior.

6. **COMMON TOOL & PATH PITFALLS**:
   - **Tool Naming**: Use `open_file` to read files. Use `write_file` to save files/payloads.
   - **Shell Commands**: NEVER prepend `command:` or `bash:` to your shell command strings. Just use the raw command (e.g., `curl ...`, not `command:curl ...`).
   - **URL Quoting**: ALWAYS wrap your URLs in single quotes for `curl` to avoid shell expansion errors (e.g., `curl 'http://target?a=1&b=2'`). Exit code 3 (000) often means the URL was malformed by the shell.
   - **Path Accuracy**:
     - If `routes/auth.js` does not exist, check for `routes/auth.ts` or `routes/auth/index.ts`.
     - In this repository, code is often in `routes/`, `lib/`, or `models/`.
     - Use `find . -maxdepth 3 -name "*<partial_name>*"` if a specific path fails.
   - **Exploitation Queue**: If `sqli_exploitation_queue.json` (or similar) is missing, read the corresponding analysis deliverable (e.g., `sqli_analysis_deliverable.md`) and manually extract targets.
   - **JSON Errors**: If you get "unexpected EOF", you likely have a quoting issue in a `bash` command. Switch to using `write_file` for your payload.
   - **Playwright overlays**: If a click fails due to an overlay, try `page.evaluate(() => document.querySelector("...").click())` or close the overlay first.
