# EXPLOITATION STAGNATION & WAF DEFENSE RULES

1. **WAF/SECURITY BLOCK SENSITIVITY**:
   - If a request returns "Malicious activity detected", "Blocked illegal activity", or HTTP 403/406 with security-related messages, you MUST assume a WAF or security filter is active.
   - DO NOT retry the exact same payload with minor variations more than 3 times on the same endpoint.
   - After 3 blocks, you MUST change your strategy:
     - Try different encoding (Base64, URL double encoding, Null byte injection).
     - Try different headers (X-Forwarded-For, X-Originating-IP, User-Agent).
     - Move to a different vulnerable candidate/endpoint if available.

2. **SHELL QUOTING & COMPLEX PAYLOADS**:
   - INSTEAD: Use the `write_file` tool (alias) to save your payload to a file.
     - Example: `write_file({"path": "payload.json", "content": "{\"key\": \"value's quote\"}"})`
   - THEN: Use `curl -d @payload.json ...` to send the payload. This is the most robust way to avoid shell syntax errors.

3. **PROGRESS CHECK**:
   - Every 5 turns of exploitation, review your `todo.txt` and current situation. If you have been doing the same activity without a change in response behavior, you are likely in a loop.
   - Break the loop by explicitly stating "Current approach is blocked/failing, switching to [New Technique]" in your thoughts.
   - If you perform 2–3 consecutive file searches or file reads without executing a real HTTP request, you MUST switch to an execution step (curl/Playwright) before any further analysis.

4. **PERSISTENCE vs. FUTILITY**:
   - While you are encouraged to be persistent, do not be futile. If an endpoint is fundamentally protected by a robust filter that you've tried many bypasses for, document it as "Highly Defended / Likely Non-Exploitable" and move on.

5. **CONTROLLED STOP CONDITIONS**:
   - If you have attempted at least 3 distinct techniques (not just minor variants) and responses remain unchanged, you MAY stop further attempts for that vector.
   - If external constraints prevent execution (rate limits, mandatory MFA you cannot satisfy, environment blocks), classify as `POTENTIAL` and record the blocking factor.
   - Do not loop indefinitely. Document the last 3 payloads/requests attempted and the observed behavior.

6. **TODO INTEGRITY**:
   - Only mark a task `[✓]` after at least one real HTTP request has been executed for that task and the result is recorded.
   - Do NOT mark tasks complete based solely on code review or hypothesis.

7. **COMMON TOOL & PATH PITFALLS**:
   - **Tool Naming**: Use `open_file` to read files. Use `write_file` to save files/payloads.
   - **Shell Commands**: NEVER prepend `command:` or `bash:` to your shell command strings. Just use the raw command (e.g., `curl ...`, not `command:curl ...`).
   - **Command Wrapping**: NEVER wrap shell commands inside a JSON string (e.g., `"{\"command\":\"curl ...\"}"`). Provide the raw command in the tool input, and pass `cwd` separately.
   - **URL Quoting**: ALWAYS wrap your URLs in single quotes for `curl` to avoid shell expansion errors (e.g., `curl 'http://target?a=1&b=2'`). Exit code 3 (000) often means the URL was malformed by the shell.
   - **Path Accuracy**:
     - If `routes/auth.js` does not exist, check for `routes/auth.ts` or `routes/auth/index.ts`.
     - In this repository, code is often in `routes/`, `lib/`, or `models/`.
     - Use `find . -maxdepth 3 -name "*<partial_name>*"` if a specific path fails.
   - **Exploitation Queue**: If `sqli_exploitation_queue.json` (or similar) is missing, read the corresponding analysis deliverable (e.g., `sqli_analysis_deliverable.md`) and manually extract targets.
   - **JSON Errors**: If you get "unexpected EOF", you likely have a quoting issue in a `bash` command. Switch to using `write_file` for your payload.
   - **Playwright overlays**: If a click fails due to an overlay, try `page.evaluate(() => document.querySelector("...").click())` or close the overlay first.
   - **Overlay recovery (generic)**: If a login or click is blocked by an overlay/backdrop, first press `Escape`, then attempt to click any visible dismiss/close buttons, then re-snapshot before retrying.

8. **HEAVY COMMAND GUARDRAILS**:
   - Do NOT run expansive commands like `ls -R` or `grep -R` from `/`. These cause timeouts and waste turns.
   - Always scope filesystem searches to the repo root and use `rg` with a narrow pattern, or `find . -maxdepth N`.
   - If a command times out once, immediately switch to a narrower/smaller command.

9. **EXECUTION-OVER-ANALYSIS RULE**:
   - After any timeout or after 2 consecutive search/read operations, you MUST perform one concrete HTTP request (curl/Playwright) tied to the current exploit objective.

10. **HARD STOP ON FILE-READ LOOPS**:
   - If you have already read 2 files for the current vulnerability and still have not executed a live request, you MUST STOP all further file reads/searches.
   - At that point, you MUST execute a live request (curl/Playwright) or explicitly document why you cannot proceed and move on.

11. **EXECUTION INTEGRITY (NON-NEGOTIABLE)**:
   - If a tool command returns a non-zero exit code or an error, you MUST treat the attempt as failed.
   - Do NOT fabricate responses, status codes, or bodies. Evidence must come from actual tool output.
   - If a command fails due to wrapping (`command:`/`bash:`/JSON string), rewrite it as a raw shell command and re-run.
   - Only save evidence after at least one real request succeeds and you have captured the real response.
