# Example configuration file for pentest-agent
# Copy this file and modify it for your specific testing needs

authentication:
  login_type: form  # Options: 'form' or 'sso'
  login_url: "https://example.com/login"
  credentials:
    username: "testuser"
    password: "testpassword"
    totp_secret: "JBSWY3DPEHPK3PXP"  # Optional TOTP secret for 2FA
    # totp_code: "000000"           # Optional fixed OTP code for login flows using static codes

  # Natural language instructions for login flow
  login_flow:
    - "Type $username into the email field"
    - "Type $password into the password field"
    - "Click the 'Sign In' button"
    - "Enter $totp in the verification code field"
    - "Click 'Verify'"

  success_condition:
    type: url_contains  # Options: 'url_contains' or 'element_present'
    value: "/dashboard"

# Detailed application profile for AI context
profile:
  application_overview: |
    This is a modern e-commerce platform built with a microservices architecture.
    The application handles product catalog management, user authentication, shopping cart,
    order processing, and payment integration. It serves both web and mobile clients through
    a unified REST API. The platform supports multiple user roles: customers, vendors, and administrators.

    Key features include:
    - Product search and filtering with Elasticsearch
    - Real-time inventory management
    - Multi-currency support
    - Promotional codes and discount system
    - User reviews and ratings
    - Wishlist and saved items
    - Order tracking and notifications

  authentication_architecture: |
    The application uses JWT-based authentication with refresh tokens:
    - Access tokens expire after 15 minutes (stored in memory)
    - Refresh tokens expire after 7 days (stored in httpOnly cookies)
    - Token refresh endpoint: POST /api/v1/auth/refresh

    User roles and permissions:
    - Customer: Can browse products, place orders, manage profile
    - Vendor: Can manage their product listings, view sales analytics
    - Admin: Full access to all resources, user management, system configuration

    Authorization is enforced at both API gateway and service levels.
    Role checks use a custom middleware that validates JWT claims.

    Password reset flow:
    1. User requests reset via email
    2. System sends time-limited token (valid for 1 hour)
    3. Token is validated against Redis cache
    4. New password must meet complexity requirements (min 8 chars, 1 uppercase, 1 number)

  api_endpoints: |
    Authentication & User Management:
    - POST /api/v1/auth/login - User login (returns JWT access + refresh tokens)
    - POST /api/v1/auth/logout - Invalidate refresh token
    - POST /api/v1/auth/refresh - Get new access token using refresh token
    - POST /api/v1/auth/register - Create new user account
    - POST /api/v1/auth/forgot-password - Request password reset email
    - POST /api/v1/auth/reset-password - Reset password with token
    - GET /api/v1/users/me - Get current user profile (requires auth)
    - PUT /api/v1/users/me - Update user profile (requires auth)
    - DELETE /api/v1/users/{id} - Delete user (admin only)

    Product Catalog:
    - GET /api/v1/products - List products (supports pagination, filtering, sorting)
    - GET /api/v1/products/{id} - Get product details
    - POST /api/v1/products - Create product (vendor/admin only)
    - PUT /api/v1/products/{id} - Update product (vendor/admin only)
    - DELETE /api/v1/products/{id} - Delete product (admin only)
    - GET /api/v1/products/search?q={query} - Search products (uses Elasticsearch)
    - POST /api/v1/products/{id}/reviews - Add product review (requires auth)

    Shopping Cart & Orders:
    - GET /api/v1/cart - Get current user's cart
    - POST /api/v1/cart/items - Add item to cart
    - PUT /api/v1/cart/items/{id} - Update cart item quantity
    - DELETE /api/v1/cart/items/{id} - Remove item from cart
    - POST /api/v1/orders - Create order from cart (requires auth)
    - GET /api/v1/orders - List user's orders (requires auth)
    - GET /api/v1/orders/{id} - Get order details (requires auth)
    - POST /api/v1/orders/{id}/cancel - Cancel order (requires auth)

    Admin Endpoints:
    - GET /api/v1/admin/users - List all users (admin only)
    - PUT /api/v1/admin/users/{id}/role - Change user role (admin only)
    - GET /api/v1/admin/analytics - System analytics dashboard (admin only)
    - POST /api/v1/admin/promotions - Create promotional code (admin only)

    File Upload:
    - POST /api/v1/upload/product-image - Upload product image (max 5MB, jpg/png only)
    - POST /api/v1/upload/profile-avatar - Upload user avatar (max 2MB)

  data_flow: |
    Request Flow:
    1. Client → Nginx reverse proxy → API Gateway
    2. API Gateway validates JWT and routes to appropriate microservice
    3. Microservice processes request and interacts with database
    4. Response flows back through gateway to client

    Database Interactions:
    - PostgreSQL for transactional data (users, orders, products)
    - MongoDB for product reviews and user activity logs
    - Redis for session storage, cart data, and rate limiting
    - Elasticsearch for product search indexing

    External Services:
    - Stripe API for payment processing
    - SendGrid for transactional emails
    - AWS S3 for product image storage
    - Cloudflare CDN for static assets

    File Upload Flow:
    - Images are validated for type and size
    - Files are scanned for malware using ClamAV
    - Uploaded to S3 with unique UUID filename
    - Database stores S3 URL reference

  security_controls: |
    Input Validation:
    - All API inputs validated using Joi schemas
    - SQL injection prevention via parameterized queries (Sequelize ORM)
    - XSS prevention via output encoding (React auto-escapes)
    - File upload restrictions: whitelist extensions, max size limits

    Rate Limiting:
    - Login endpoint: 5 attempts per 15 minutes per IP
    - API endpoints: 100 requests per minute per user
    - Search endpoint: 20 requests per minute per IP

    CORS Configuration:
    - Allowed origins: https://example.com, https://app.example.com
    - Credentials: true (allows cookies)
    - Allowed methods: GET, POST, PUT, DELETE

    CSP Policy:
    - default-src 'self'
    - script-src 'self' 'unsafe-inline' https://cdn.example.com
    - img-src 'self' https://s3.amazonaws.com data:

    CSRF Protection:
    - Double-submit cookie pattern for state-changing operations
    - Token validated on POST/PUT/DELETE requests

    Known Weaknesses:
    - Admin panel accessible without IP whitelist
    - Password complexity not enforced on legacy accounts
    - No rate limiting on password reset requests

  business_logic: |
    Critical Workflows:

    1. Order Processing:
       - Cart items locked during checkout to prevent race conditions
       - Inventory decremented atomically using database transactions
       - Payment processed before order confirmation
       - Failed payments trigger automatic cart restoration
       - Order status: pending → processing → shipped → delivered

    2. Promotional Codes:
       - Codes can be percentage-based or fixed amount
       - Single-use codes marked as used after application
       - Expiration dates enforced at application time
       - Stacking rules: only one code per order
       - Edge case: Code validation happens before payment, potential for reuse if payment fails

    3. User Registration:
       - Email verification required before account activation
       - Duplicate email check performed case-insensitively
       - Default role assigned: 'customer'
       - Welcome email sent asynchronously via message queue

    4. Privilege Escalation Paths:
       - Vendor role can be self-requested via /api/v1/users/request-vendor-role
       - Admin must approve vendor requests via /api/v1/admin/approve-vendor/{id}
       - No automated checks on vendor approval (potential for abuse)

    5. Password Reset:
       - Token generated with crypto.randomBytes(32)
       - Token stored in Redis with 1-hour TTL
       - Token is single-use (deleted after successful reset)
       - Edge case: Multiple reset requests generate multiple valid tokens

  technology_stack: |
    Frontend:
    - React 18.2.0 with TypeScript
    - Redux Toolkit for state management
    - React Router v6 for routing
    - Axios for HTTP requests
    - Material-UI v5 for components

    Backend:
    - Node.js v18.17.0
    - Express.js v4.18.2
    - Sequelize ORM v6.32.1
    - Passport.js for authentication
    - jsonwebtoken v9.0.1

    Databases:
    - PostgreSQL 15.3 (primary database)
    - MongoDB 6.0 (logs and reviews)
    - Redis 7.0 (caching and sessions)
    - Elasticsearch 8.8.0 (search)

    Infrastructure:
    - Docker containers orchestrated with Kubernetes
    - Nginx 1.24 as reverse proxy
    - AWS EC2 for compute
    - AWS S3 for file storage
    - Cloudflare for CDN and DDoS protection

  custom_notes: |
    Testing Priorities:
    1. Focus on authentication bypass techniques - JWT secret may be weak
    2. Test IDOR vulnerabilities in order and user endpoints
    3. Examine file upload for path traversal and malicious file execution
    4. Check for race conditions in promotional code application
    5. Verify authorization checks on admin endpoints

    Known Issues from Previous Tests:
    - /api/v1/admin/analytics endpoint had verbose error messages exposing database schema
    - Product search query parameter was vulnerable to NoSQL injection (MongoDB)
    - CORS misconfiguration allowed requests from any subdomain

    Special Considerations:
    - The application uses GraphQL for internal service communication (not exposed externally)
    - Webhook endpoint /api/v1/webhooks/stripe for payment callbacks (verify signature validation)
    - Background job processor uses Bull queue - check for job injection vulnerabilities

rules:
  avoid:
    - description: "Do not test the marketing site subdomain"
      type: subdomain
      url_path: "www"

    - description: "Skip logout functionality"
      type: path
      url_path: "/logout"

    - description: "No DELETE operations on user API"
      type: path
      url_path: "/api/v1/users/*"

  focus:
    - description: "Prioritize beta admin panel subdomain"
      type: subdomain
      url_path: "beta-admin"

    - description: "Focus on user profile updates"
      type: path
      url_path: "/api/v2/user-profile"
