# 웹 펜테스트 실행 시간 분석 보고서

**세션**: `audit-logs/172-20-208-1_f5bca825-2483-4252-9759-33a337ba2b33`  
**기준**: 사용자 보고 5시간 44분 수행 중, session.json 스냅샷 기준 약 3시간 시점 4개 vuln 완료  
**작성일**: 2026-02-15

---

## 1. 요약

- **원인 요약**: “밀도 있는 꼼꼼한 검증”과 “루핑/의미 없는 반복”이 **둘 다** 존재합니다.
- **가장 큰 시간 소비**: (1) **Recon 단계** ~77분, (2) **Pre-recon** ~23분(92+43 턴, 1회 실패 후 재시도), (3) **Vuln 에이전트** 다수 50~107 턴 + **재시도 3건**(pathi, auth, ssrf).
- **반복/비효율**: 동일 파일(`server.ts`) 다수 오픈, 동일 검색(`app.` 등) 반복, **파일/검색 상한은 프롬프트만 있고 런타임 강제 없음**, 턴 상한(PRERECON 800, RECON 500)이 과도하게 커서 에이전트가 끝까지 돌아감.

---

## 2. 세션·메트릭스 요약 (session.json 기준)

| 구분 | 값 |
|------|-----|
| total_duration_ms (스냅샷) | 10,860,500 (~3h 1m) |
| pre-recon | 1,384,267 ms (~23m), 1 에이전트, 3.5M prompt tokens |
| recon (phase) | 5,569,351 ms (~92m), 3 에이전트(login-check, recon-verify, recon) |
| recon (에이전트만) | 4,635,995 ms (~77m), 2.4M prompt tokens |
| vulnerability-analysis | 3,814,405 ms (~63m), 4 에이전트 완료 (codei, xss, ssti, sqli) |

스냅샷 시점에는 pathi/auth/ssrf/authz vuln은 미완료 또는 진행 중. 사용자 기준 5h 44m이면 그 이후 exploitation·reporting 등 추가 실행 구간이 더 있음.

---

## 3. 에이전트별 턴 수 (console.log “Turn N (phase)” 로그 줄 수 ÷2)

| 에이전트 | Turn 로그 수 | 추정 실제 턴 | 비고 |
|----------|-------------|--------------|------|
| pre-recon | 271 | ~135 | attempt 1 (92턴) 실패 → attempt 2 |
| recon | 246 | ~123 | attempt 1 실패 가능성, attempt 2로 성공 |
| login-check | 12 | ~6 | |
| recon-verify | 28 | ~14 | |
| api-fuzzer | 9 | ~5 | |
| sqli-vuln | 214 | ~107 | |
| ssrf-vuln | 217 | ~108 | |
| auth-vuln | 169 | ~84 | attempt 2 존재 |
| authz-vuln | 124 | ~62 | |
| pathi-vuln | 101 | ~50 | attempt 1 + 2 |
| ssti-vuln | 78 | ~39 | |
| codei-vuln | 50 | ~25 | |
| xss-vuln | 23 | ~12 | |

- Pre-recon·Recon이 **팀 단위로** 가장 많은 턴을 소비.
- Vuln 중에서는 sqli, ssrf, auth가 80~108 턴으로 가장 김.

---

## 4. 툴 사용 분포 (console.log 전체)

| 툴 | 호출 수 |
|----|--------|
| search_file | 771 |
| open_file | 631 |
| list_files | 62 |

- **총 1,464회** 파일/검색 관련 호출. 프롬프트의 “12 file opens / 8 searches” Hard Cap과 비교하면 **프롬프트만의 규칙은 전혀 지켜지지 않음** → 상한은 **런타임에서 강제되지 않음**.

---

## 5. 중복·반복 패턴

### 5.1 동일 파일 반복 오픈

- `server.ts`에 대한 `open_file`:
  - pre-recon attempt-1: 30회
  - pre-recon attempt-2: 55회
  - recon attempt-1: 23회
  - recon attempt-2: 9회
- 같은 파일을 여러 턴에 걸쳐 반복 오픈 → **이미 읽은 파일에 대한 캐시/힌트가 없음**.

### 5.2 동일 검색 반복

- pre-recon에서 `search_file` path=`server.ts`, query=`app.` → “No matches found” 수차례.
- Express 앱은 `app`이 아니라 변수명/패턴이 다를 수 있는데, 동일 실패 검색을 반복.

### 5.3 프롬프트 규칙과 실제 동작 괴리

- `_analysis-efficiency-limits.txt`: “NO-REDUNDANCY: If you have already analyzed a file and found no vulnerability, do not open it again.”
- `_analysis-stop-rules.txt`: “You find yourself repeating the same searches or file-read operations without new findings” 시 종료하라 함.
- 실제로는 **반복이 그대로 발생** → 규칙이 모델에 의해 충분히 준수되지 않거나, **이미 읽은 파일/검색 이력**을 툴/프롬프트에서 명시적으로 주지 않음.

---

## 6. 재시도(attempt 2) 정리

- **Pre-recon**: attempt 1 실패 후 “Rolling back workspace for Pre-recon agent (retry cleanup)” → attempt 2. (deliverable 검증 실패 또는 저장 실패 추정.)
- **Path injection vuln**, **Auth vuln**, **SSRF vuln**: 각각 attempt-1, attempt-2 로그 존재 → 3개 에이전트가 1회 실패 후 재시도.
- 재시도 시 동일 워크플로를 다시 수행 → **총 시간이 최대 2배까지 늘어날 수 있는 구조**.

---

## 7. 설정 상의 요인

- `.env` (및 참고용 .env.20b / .env.qwen3.235b):
  - `DOKODEMODOOR_PRERECON_MAX_TURNS=800`
  - `DOKODEMODOOR_RECON_MAX_TURNS=500`
- Pre-recon은 최대 800턴까지 허용 → 92턴으로 한 번 실패한 뒤 재시도에서도 수십 턴 더 사용 가능.
- Recon은 최대 500턴 → 123턴 사용. “빠르게 산출물 내고 끝내라”는 압력이 상대적으로 약함.

---

## 8. 결론: “오래 도는 이유” 구분

| 구분 | 설명 |
|------|------|
| **의도된 밀도** | Pre-recon·Recon이 코드베이스/라우트/엔드포인트를 넓게 커버하려다 보면 턴·파일 수가 많아지는 것은 어느 정도 자연스러움. |
| **불필요한 반복** | (1) 동일 파일(`server.ts` 등) 반복 오픈, (2) 동일 검색(`app.` 등) 반복, (3) “같은 검색/파일 읽기를 반복하지 말라”는 프롬프트 규칙 미준수. |
| **구조적 요인** | (1) **파일/검색 상한(12 file / 8 search)이 런타임에 강제되지 않음**, (2) PRERECON/RECON **max_turns 상한이 과도하게 큼**, (3) **재시도 시 전체 워크플로 재실행**으로 3개 vuln에서 시간 2배 가능성. |

---

## 9. 개선 권고 (구현 전 확인 필요)

- 아래는 **분석 결과에 따른 권고**이며, 코드/설정 변경은 사용자 확인 후 진행하는 것이 전제입니다.

### 9.1 런타임 상한 강제 (우선순위 높음)

- **파일 오픈/검색 상한**:  
  vuln(및 필요 시 recon/pre-recon)에서 `open_file` / `search_file` / `list_files` 호출 횟수를 **런타임에서** 집계하고,  
  프롬프트의 “12 file opens / 8 searches” 등에 도달하면 **해당 턴에서 더 이상 파일/검색 툴 호출을 허용하지 않거나**, 툴 응답으로 “Cap reached, proceed to deliverables” 안내를 반환.
- 에이전트별로 상한 값을 설정 가능하게 두고, `.env` 또는 config에서 조정할 수 있게 하는 것 권장.

### 9.2 Pre-recon / Recon 턴 상한 축소

- `DOKODEMODOOR_PRERECON_MAX_TURNS`: 800 → 200~300 구간으로 낮춰 검토.  
  (실제 사용 턴이 92+43 수준이므로, 250 전후로도 목표 달성 가능성 있음.)
- `DOKODEMODOOR_RECON_MAX_TURNS`: 500 → 200~250 구간으로 낮춰 검토.  
  (실제 123턴이면 상한 250으로도 여유 있음.)
- 변경 시 기존 품질(산출물 완성도)을 한두 런으로 비교해 보는 것이 안전함.

### 9.3 재시도 시 비용 절감

- 재시도 시 **전체 턴을 다시 돌리기보다**,  
  “실패 원인(예: save_deliverable 검증 실패)”만 보완하는 **짧은 보정 턴**만 두는 모드 검토.  
  (예: attempt 2를 “저장/포맷 수정 전용” 제한 턴으로 제한.)
- 또는 재시도 시 **max_turns를 절반 이하로 제한**하는 옵션을 두어, 무한에 가까운 재실행을 막는 방법.

### 9.4 중복 오픈/검색 완화 (중장기)

- **이미 읽은 파일 목록**을 세션/컨텍스트에 유지하고,  
  `open_file` 호출 시 “이미 읽음: server.ts (요약 링크)” 형태로 짧게 주입해, 동일 파일 재오픈 유도 감소.
- **최근 search_file 쿼리·결과 요약**을 컨텍스트에 포함해, “동일/유사 검색 반복”을 줄이기.  
  (구현 복잡도와 토큰 비용 타협 필요.)

### 9.5 프롬프트 보강 (저비용)

- Pre-recon/Recon 프롬프트에  
  “**이미 open_file 또는 search_file로 확인한 path/query는 다시 호출하지 말 것. 이전 턴 요약을 참고해 진행할 것.**”  
  를 명시적으로 한 줄 추가.
- Vuln 공통에  
  “**12 file opens / 8 searches Hard Cap은 절대 상한이며, 이에 도달하면 즉시 save_deliverable로 넘어갈 것.**”  
  를 다시 한 번 강조.

---

## 10. 참고: proxy_metrics vs session 메트릭

- 예: ssti-vuln  
  - `ssti-vuln_proxy_metrics.json`: duration_ms 435,551  
  - session.json: ssti-vuln duration 1,980,042 ms  
- Proxy 메트릭은 “MCP/툴 구간”만 잰 것으로 보이고, session은 “에이전트 전체(LLM 대기+툴)”로 해석 가능.  
  분석 시 **session 기준 duration**을 기준으로 삼는 것이 일관적임.

---

이 문서는 **분석만** 포함하며, 코드/설정 수정은 사용자 확인 후 진행해야 합니다.

---

## 실행 시간 단축 권장 (적용 후)

- **PRERECON / RECON 턴 상한**: 실행 시간 단축을 위해 `DOKODEMODOOR_PRERECON_MAX_TURNS=200~300`, `DOKODEMODOOR_RECON_MAX_TURNS=200~250` 권장. `.env.example` 및 프로필별 `.env.*` 에 반영됨.
